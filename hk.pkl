// Install with `hk install --mise` to ensure local tools are available

amends "package://github.com/jdx/hk/releases/download/v0.8.2/hk@0.8.2#/Config.pkl"
import "package://github.com/jdx/hk/releases/download/v0.8.2/hk@0.8.2#/Builtins.pkl"

min_hk_version = "0.8.2"

local file_list = List("**/*.{gitignore,go,md,pkl,toml,yaml,yml}")

local linters = new Mapping<String, Step> {
    ["actionlint"] = Builtins.actionlint
    ["golangci-lint"] {
        glob = List("**/*.go")
        check = "golangci-lint run"
        fix = "golangci-lint run --fix"
    }
    ["go-test"] {
        glob = List("**/*.go")
        check = "go test ./..."
    }
    ["pkl"] {
        glob = List("*.pkl")
        check = "pkl eval {{files}} >/dev/null"
    }
    ["toml-sort"] {
        glob = List("**/*.toml")
        check = "toml-sort --check {{ files }}"
        fix = "toml-sort --in-place {{ files }}"
    }
}

local commit_msg_checks = new Mapping<String, Step> {
    ["commitizen"] {
        check = "cz check --allow-abort --commit-msg-file={{commit_msg_file}}"
    }
}

local pre_push_checks = new Mapping<String, Step> {
    ["commitizen-branch"] {
        check = "cz check --rev-range origin/HEAD..HEAD"
    }
}

hooks = new {
    ["pre-commit"] {
        fix = true
        stash = "patch-file"
        steps = linters
    }
    ["pre-push"] {
        steps = new {
            ...pre_push_checks
            ...linters
        }
    }
    ["commit-msg"] {
        steps = commit_msg_checks
    }
    ["fix"] {
        fix = true
        steps = linters
    }
    ["check"] {
        steps = new {
            ...pre_push_checks
            ...linters
        }
    }
}
